<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ total }}</div>
        <div class="stat-label">Total charges</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color:#10b981;">{{ ok }}</div>
        <div class="stat-label">R√©ussite</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color:#ef4444;">{{ nok }}</div>
        <div class="stat-label">√âchec</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color:#3b82f6;">{{ taux_reussite }}%</div>
        <div class="stat-label">Taux de r√©ussite</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color:#f59e0b;">{{ taux_echec }}%</div>
        <div class="stat-label">Taux d'√©chec</div>
    </div>
</div>

<div style="display:flex; flex-direction:column; gap:1.25rem;">
    <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-sm); padding:1rem;">
        <div style="font-weight:700; margin-bottom:0.75rem; color:var(--color-text);">R√©capitulatif des erreurs par site et moment</div>
        {% if recap_rows %}
        <style>
            .recap-table-wrapper {
                overflow:auto;
                max-height:520px;
                border:1px solid var(--color-border);
                border-radius:var(--radius-sm);
            }
            table.recap-table {
                width:100%;
                border-collapse:collapse;
                min-width:720px;
            }
            .recap-table thead th {
                position: sticky;
                top: 0;
                background: var(--color-surface);
                cursor: pointer;
            }
            .recap-table th.sorted-asc::after { content: ' ‚ñ≤'; font-size: 0.75rem; color: var(--color-text-muted); }
            .recap-table th.sorted-desc::after { content: ' ‚ñº'; font-size: 0.75rem; color: var(--color-text-muted); }
            .recap-table tbody tr:nth-child(even) { background: #f9fafb; }
        </style>
        <div class="recap-table-wrapper">
            {% set integer_columns = ['Init', 'Lock Connector', 'CableCheck', 'Charge', 'Fin de charge', 'Unknown'] %}
            <table id="recap-table" class="recap-table">
                <thead>
                    <tr>
                        {% for col in recap_columns %}
                        {% set is_numeric = col in integer_columns or col in ['Total', 'Total_OK', 'Total_NOK', '% OK', '% NOK'] %}
                        <th data-sortable="true" data-type="{{ 'number' if is_numeric else 'text' }}" style="text-align:left; padding:0.5rem; font-size:0.85rem; color:var(--color-text-muted); border-bottom:1px solid var(--color-border); white-space:nowrap;">{{ col }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in recap_rows %}
                    <tr>
                        {% for col in recap_columns %}
                        {% set value = row[col] %}
                        {% set is_integer = col in integer_columns %}
                        <td data-sort-value="{{ value }}" style="padding:0.5rem; font-size:0.9rem; border-bottom:1px solid var(--color-border); color:var(--color-text);">
                            {% if col in ['% OK', '% NOK'] %}
                                {{ value | round(2) }}%
                            {% elif is_integer %}
                                {{ value | int }}
                            {% else %}
                                {{ value }}
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <script>
            (() => {
                const table = document.getElementById('recap-table');
                if (!table) return;

                const headers = table.querySelectorAll('th[data-sortable]');
                const tbody = table.querySelector('tbody');
                let currentSort = { index: null, dir: 'asc' };

                const parseValue = (text, type) => {
                    const cleaned = text.replace('%', '').replace(/\s+/g, '');
                    if (type === 'number' && cleaned !== '' && !isNaN(cleaned)) {
                        return parseFloat(cleaned);
                    }
                    return cleaned.toLowerCase();
                };

                const applySort = (index, type) => {
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const dirMultiplier = currentSort.dir === 'asc' ? 1 : -1;

                    rows.sort((a, b) => {
                        const aVal = parseValue(a.children[index].dataset.sortValue ?? a.children[index].textContent.trim(), type);
                        const bVal = parseValue(b.children[index].dataset.sortValue ?? b.children[index].textContent.trim(), type);

                        if (aVal < bVal) return -1 * dirMultiplier;
                        if (aVal > bVal) return 1 * dirMultiplier;
                        return 0;
                    });

                    rows.forEach(row => tbody.appendChild(row));
                };

                const updateIndicators = (clickedIndex) => {
                    headers.forEach((th, idx) => {
                        th.classList.remove('sorted-asc', 'sorted-desc');
                        if (idx === clickedIndex) {
                            th.classList.add(currentSort.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
                        }
                    });
                };

                headers.forEach((th, index) => {
                    th.addEventListener('click', () => {
                        const type = th.dataset.type || 'text';
                        if (currentSort.index === index) {
                            currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentSort = { index, dir: 'asc' };
                        }
                        applySort(index, type);
                        updateIndicators(index);
                    });
                });
            })();
        </script>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üìä</div>
            <div>Aucune donn√©e r√©capitulative disponible pour ce p√©rim√®tre.</div>
        </div>
        {% endif %}
    </div>

    <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-sm); padding:1rem;">
        <div style="font-weight:700; margin-bottom:0.75rem; color:var(--color-text);">R√©partition des erreurs par moment</div>
        {% if moment_distribution %}
        <div class="bar-chart">
            {% for item in moment_distribution %}
            <div class="bar-row">
                <span class="bar-label">{{ item.moment }}</span>
                <div class="bar-container">
                    <div class="bar bar-danger" style="width: {{ item.percent }}%;"></div>
                </div>
                <span class="bar-value text-danger">{{ item.count }}</span>
            </div>
            {% endfor %}
        </div>
        <div style="margin-top:0.5rem; font-weight:600; color:var(--color-text);">Total erreurs : {{ moment_total_errors }}</div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">‚úÖ</div>
            <div>Aucune erreur sur la p√©riode s√©lectionn√©e.</div>
        </div>
        {% endif %}
    </div>
</div>
