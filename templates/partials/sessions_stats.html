<!-- Fragment: Statistiques compl√®tes -->
{% if no_data %}
<div class="empty-state">
    <div class="empty-icon">üìä</div>
    <div>Aucune donn√©e pour cette p√©riode</div>
</div>
{% else %}

<style>
.stats-kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 1.5rem;
}
.stats-kpi-card {
    background: #0f172a;
    border: 1px solid #1f2937;
    border-radius: 14px;
    padding: 14px 16px;
    box-shadow: 0 2px 10px rgba(0,0,0,.15);
}
.stats-kpi-title {
    font-size: 13px;
    color: #cbd5e1;
    margin: 0 0 6px 0;
}
.stats-kpi-value {
    font-size: 24px;
    font-weight: 700;
    color: #f8fafc;
    margin: 0;
}
.stats-kpi-sub {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 4px;
}
.stats-kpi-tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    margin-left: 6px;
    background: #111827;
    border: 1px solid #334155;
    color: #93c5fd;
}
.stats-section-title {
    font-weight: 600;
    font-size: 1.1rem;
    margin: 24px 0 12px 0;
    color: #1e293b;
}
.stats-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
    margin: 1.5rem 0;
}
.stats-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    font-size: 0.9rem;
}
.stats-table th {
    background: #f8fafc;
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    color: #64748b;
    border-bottom: 2px solid #e2e8f0;
}
.stats-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #f1f5f9;
}
.stats-table tr:hover {
    background: #fafbfc;
}
.stats-selector {
    margin: 1rem 0;
    padding: 0.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    background: white;
}
</style>

<h3 style="font-size: 1.25rem; margin-bottom: 1rem; color: #1e293b;">üìä Statistiques g√©n√©rales</h3>

<!-- R√©sum√© global -->
<div class="stats-kpi-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 2rem;">
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Total charges</div>
        <div class="stats-kpi-value" style="color: #3b82f6;">{{ total_charges }}</div>
    </div>
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Charges OK</div>
        <div class="stats-kpi-value" style="color: #10b981;">{{ total_ok }}</div>
    </div>
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Charges NOK</div>
        <div class="stats-kpi-value" style="color: #ef4444;">{{ total_nok }}</div>
    </div>
</div>

<div class="stats-divider"></div>

<!-- √ânergie -->
<h4 class="stats-section-title">
    ‚ö° √ânergie
    <span class="stats-kpi-tag">Total : tous statuts</span>
    <span class="stats-kpi-tag">Moy./Max : OK only</span>
</h4>
<div class="stats-kpi-grid">
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Total (kWh)</div>
        <div class="stats-kpi-value">{{ e_total_all }}</div>
        <div class="stats-kpi-sub">Tous statuts</div>
    </div>
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Moyenne (kWh)</div>
        <div class="stats-kpi-value">{{ e_mean }}</div>
    </div>
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Max (kWh)</div>
        <div class="stats-kpi-value">{{ e_max }}</div>
    </div>
</div>

<div class="stats-divider"></div>

<!-- Puissance moyenne -->
<h4 class="stats-section-title">
    üîå Puissance moyenne (kW)
    <span class="stats-kpi-tag">OK only</span>
</h4>
<div class="stats-kpi-grid" style="grid-template-columns: repeat(2, 1fr);">
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Moyenne (kW)</div>
        <div class="stats-kpi-value">{{ pm_mean }}</div>
    </div>
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Max (kW)</div>
        <div class="stats-kpi-value">{{ pm_max }}</div>
    </div>
</div>

<div class="stats-divider"></div>

<!-- Puissance maximale -->
<h4 class="stats-section-title">
    üöÄ Puissance maximale (kW)
    <span class="stats-kpi-tag">OK only</span>
</h4>
<div class="stats-kpi-grid" style="grid-template-columns: repeat(2, 1fr);">
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Moyenne (kW)</div>
        <div class="stats-kpi-value">{{ px_mean }}</div>
    </div>
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Max (kW)</div>
        <div class="stats-kpi-value">{{ px_max }}</div>
    </div>
</div>

<div class="stats-divider"></div>

<!-- SOC -->
<h4 class="stats-section-title">
    üîã SOC (State of Charge)
    <span class="stats-kpi-tag">OK only</span>
</h4>
<div class="stats-kpi-grid">
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">SOC d√©but moyen (%)</div>
        <div class="stats-kpi-value">{{ soc_start_mean }}</div>
    </div>
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">SOC fin moyen (%)</div>
        <div class="stats-kpi-value">{{ soc_end_mean }}</div>
    </div>
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">SOC moyen de recharge (%)</div>
        <div class="stats-kpi-value">{{ soc_gain_mean }}</div>
    </div>
</div>

<div class="stats-divider"></div>

<!-- Dur√©es de charge -->
<h4 class="stats-section-title">
    ‚è±Ô∏è Dur√©es de charge
    <span class="stats-kpi-tag">OK only</span>
</h4>
<div class="stats-kpi-grid" style="grid-template-columns: 1fr;">
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Moyenne (minutes)</div>
        <div class="stats-kpi-value">{{ dur_mean }}</div>
    </div>
</div>

<div class="stats-divider"></div>

<!-- Charges par jour -->
<h4 class="stats-section-title">
    üìÖ Charges par jour
    <span class="stats-kpi-tag">OK only</span>
</h4>
<div class="stats-kpi-grid" style="grid-template-columns: repeat(3, 1fr);">
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Jours couverts</div>
        <div class="stats-kpi-value">{{ nb_days }}</div>
    </div>
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Moyenne / jour (OK)</div>
        <div class="stats-kpi-value">{{ mean_day }}</div>
    </div>
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">M√©diane / jour (OK)</div>
        <div class="stats-kpi-value">{{ med_day }}</div>
    </div>
</div>

{% if max_day_site != "‚Äî" %}
<div class="stats-kpi-grid" style="grid-template-columns: 1fr; margin-top: 12px;">
    <div class="stats-kpi-card">
        <div class="stats-kpi-title">Max / jour (OK)</div>
        <div class="stats-kpi-value">{{ max_day_nb }}</div>
        <div class="stats-kpi-sub">{{ max_day_date }} ‚Äî site: {{ max_day_site }}</div>
    </div>
</div>
{% endif %}

<div class="stats-divider"></div>

<!-- Dur√©es de fonctionnement -->
<h4 class="stats-section-title">‚è±Ô∏è Dur√©e de fonctionnement totale (heures)</h4>

{% if durations_by_site %}
<h5 style="font-size: 0.95rem; font-weight: 600; margin: 1rem 0 0.5rem; color: #64748b;">Par Site</h5>
<table class="stats-table">
    <thead>
        <tr>
            <th>Site</th>
            <th style="text-align: right;">Heures</th>
        </tr>
    </thead>
    <tbody>
        {% for row in durations_by_site %}
        <tr>
            <td>{{ row.Site }}</td>
            <td style="text-align: right; font-weight: 600;">{{ row.Heures }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p style="color: #94a3b8; font-style: italic;">Aucune donn√©e de dur√©e disponible.</p>
{% endif %}

{% if site_options_dur %}
<h5 style="font-size: 0.95rem; font-weight: 600; margin: 1.5rem 0 0.5rem; color: #64748b;">Par PDC</h5>
<div>
    <label for="site-selector" style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem; display: block;">üè¢ S√©lectionner un site :</label>
    <select id="site-selector" class="stats-selector" onchange="updatePDCTable()">
        {% for site in site_options_dur %}
        <option value="{{ site }}" {% if loop.index == 1 %}selected{% endif %}>{{ site }}</option>
        {% endfor %}
    </select>
</div>

<div id="pdc-table-container">
    <!-- Le tableau sera ins√©r√© ici par JavaScript -->
</div>

<script>
// Donn√©es des dur√©es par site/PDC
const durationsBySite = {{ durations_by_site_dict | tojson }};

function updatePDCTable() {
    const selector = document.getElementById('site-selector');
    const selectedSite = selector.value;
    const container = document.getElementById('pdc-table-container');

    if (!durationsBySite[selectedSite]) {
        container.innerHTML = '<p style="color: #94a3b8; font-style: italic; margin-top: 1rem;">Aucune donn√©e pour ce site.</p>';
        return;
    }

    const data = durationsBySite[selectedSite];

    let html = '<table class="stats-table" style="margin-top: 1rem;"><thead><tr><th>PDC</th><th style="text-align: right;">Heures</th></tr></thead><tbody>';

    data.forEach(row => {
        html += `<tr><td>${row.PDC}</td><td style="text-align: right; font-weight: 600;">${row.Heures}</td></tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

// Initialiser le tableau au chargement
updatePDCTable();
</script>
{% endif %}

{% endif %}
