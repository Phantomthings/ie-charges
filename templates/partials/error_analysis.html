<style>
    .analysis-grid {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 1rem;
    }
    .analysis-card {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 1rem;
        box-shadow: var(--shadow-sm);
    }
    .analysis-title {
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--color-text);
    }
    .table-wrapper {
        overflow: auto;
        margin-top: 0.5rem;
        max-height: 420px;
    }
    .analysis-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    .analysis-table th,
    .analysis-table td {
        border: 1px solid var(--color-border);
        padding: 0.5rem;
        text-align: left;
    }
    .analysis-table th {
        background: #f8fafc;
        color: var(--color-text-muted);
        font-weight: 600;
        cursor: pointer;
        user-select: none;
    }
    .analysis-table th.sorted-asc::after { content: ' ‚ñ≤'; font-size: 0.75rem; color: var(--color-text-muted); }
    .analysis-table th.sorted-desc::after { content: ' ‚ñº'; font-size: 0.75rem; color: var(--color-text-muted); }
    .analysis-table tbody tr:nth-child(even) {
        background: #f9fafb;
    }
    .message {
        padding: 0.75rem 1rem;
        background: var(--color-info-light);
        color: #1d4ed8;
        border-radius: var(--radius-md);
        border: 1px solid #bfdbfe;
        margin: 0.5rem 0;
    }
</style>

<div class="section-title">üîç Analyse des erreurs</div>

{% if no_data %}
    <div class="message">Aucune donn√©e pour la p√©riode et les filtres s√©lectionn√©s.</div>
{% elif no_errors %}
    <div class="message">Aucune erreur √† afficher pour ce p√©rim√®tre.</div>
{% else %}
    <div class="analysis-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="analysis-card">
            <div class="analysis-title">Top 3 erreurs (EVI + Downstream)</div>
            {% if top_all %}
                <div class="table-wrapper">
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                <th data-sortable="true">Moment</th>
                                <th data-sortable="true">Step</th>
                                <th data-sortable="true">Code</th>
                                <th data-sortable="true">Type</th>
                                <th data-sortable="true" data-type="number">Occurrences</th>
                                <th data-sortable="true" data-type="number">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in top_all %}
                            <tr>
                                <td>{{ row.moment_label }}</td>
                                <td>{{ row.step }}</td>
                                <td>{{ row.code }}</td>
                                <td>{{ row.type }}</td>
                                <td style="text-align:right;" data-sort-value="{{ row.Occurrences }}">{{ row.Occurrences }}</td>
                                <td style="text-align:right;" data-sort-value="{{ '%.2f'|format(row.percent) }}">{{ '%.2f'|format(row.percent) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="message">Aucune erreur combin√©e.</div>
            {% endif %}
        </div>
        <div class="analysis-card">
            <div class="analysis-title">D√©tail Top 3 par site</div>
            {% if detail_all_pivot.columns %}
                <div class="table-wrapper">
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                {% for col in detail_all_pivot.columns %}
                                    <th data-sortable="true" {% if col != 'Site' %}data-type="number"{% endif %}>{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in detail_all_pivot.rows %}
                            <tr>
                                {% for col in detail_all_pivot.columns %}
                                    <td style="text-align: {{ 'left' if col == 'Site' else 'right' }};">{{ row[col] }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="message">Aucun d√©tail disponible.</div>
            {% endif %}
        </div>
    </div>

    <div class="analysis-grid">
        <div class="analysis-card">
            <div class="analysis-title">Top 3 erreurs EVI</div>
            {% if top_evi %}
                <div class="table-wrapper">
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                <th data-sortable="true">Moment</th>
                                <th data-sortable="true">Step</th>
                                <th data-sortable="true">Code EVI</th>
                                <th data-sortable="true" data-type="number">Occurrences</th>
                                <th data-sortable="true" data-type="number">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in top_evi %}
                            <tr>
                                <td>{{ row.moment_label }}</td>
                                <td>{{ row.step }}</td>
                                <td>{{ row.code }}</td>
                                <td style="text-align:right;" data-sort-value="{{ row.Occurrences }}">{{ row.Occurrences }}</td>
                                <td style="text-align:right;" data-sort-value="{{ '%.2f'|format(row.percent) }}">{{ '%.2f'|format(row.percent) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="message">Aucune erreur EVI trouv√©e.</div>
            {% endif %}
        </div>
        <div class="analysis-card">
            <div class="analysis-title">D√©tail EVI Top 3 par site</div>
            {% if detail_evi_pivot.columns %}
                <div class="table-wrapper">
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                {% for col in detail_evi_pivot.columns %}
                                    <th data-sortable="true" {% if col != 'Site' %}data-type="number"{% endif %}>{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in detail_evi_pivot.rows %}
                            <tr>
                                {% for col in detail_evi_pivot.columns %}
                                    <td style="text-align: {{ 'left' if col == 'Site' else 'right' }};">{{ row[col] }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="message">Aucun d√©tail EVI disponible.</div>
            {% endif %}
        </div>
    </div>

    <div class="analysis-grid">
        <div class="analysis-card">
            <div class="analysis-title">Top 3 erreurs Downstream</div>
            {% if top_ds %}
                <div class="table-wrapper">
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                <th data-sortable="true">Moment</th>
                                <th data-sortable="true">Step</th>
                                <th data-sortable="true">Code PC</th>
                                <th data-sortable="true" data-type="number">Occurrences</th>
                                <th data-sortable="true" data-type="number">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in top_ds %}
                            <tr>
                                <td>{{ row.moment_label }}</td>
                                <td>{{ row.step }}</td>
                                <td>{{ row.code }}</td>
                                <td style="text-align:right;" data-sort-value="{{ row.Occurrences }}">{{ row.Occurrences }}</td>
                                <td style="text-align:right;" data-sort-value="{{ '%.2f'|format(row.percent) }}">{{ '%.2f'|format(row.percent) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="message">Aucune erreur Downstream trouv√©e.</div>
            {% endif %}
        </div>
        <div class="analysis-card">
            <div class="analysis-title">D√©tail Downstream Top 3 par site</div>
            {% if detail_ds_pivot.columns %}
                <div class="table-wrapper">
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                {% for col in detail_ds_pivot.columns %}
                                    <th data-sortable="true" {% if col != 'Site' %}data-type="number"{% endif %}>{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in detail_ds_pivot.rows %}
                            <tr>
                                {% for col in detail_ds_pivot.columns %}
                                    <td style="text-align: {{ 'left' if col == 'Site' else 'right' }};">{{ row[col] }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="message">Aucun d√©tail Downstream disponible.</div>
            {% endif %}
        </div>
    </div>

    <div class="analysis-grid" style="grid-template-columns: 1fr 1fr;">
        <div class="analysis-card">
            <div class="analysis-title">EVI ‚Äî Moment √ó Code</div>
            {% if evi_moment_code %}
                <div class="table-wrapper">
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                <th data-sortable="true">Moment</th>
                                <th data-sortable="true">Step</th>
                                <th data-sortable="true">Code</th>
                                <th data-sortable="true" data-type="number">Somme de Charge_NOK</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in evi_moment_code %}
                            <tr>
                                <td>{{ row["Moment"] }}</td>
                                <td>{{ row["Step"] }}</td>
                                <td>{{ row["Code"] }}</td>
                                <td style="text-align:right;" data-sort-value="{{ row["Somme de Charge_NOK"] }}">{{ row["Somme de Charge_NOK"] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="message">Aucune erreur correspondant √† la logique 'Erreur_EVI' pour ce p√©rim√®tre.</div>
            {% endif %}

            <div class="analysis-title" style="margin-top: 1rem;">EVI ‚Äî Moment √ó Code √ó Site</div>
            {% if evi_moment_code_site %}
                <div class="table-wrapper">
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                <th data-sortable="true">Site</th>
                                <th data-sortable="true">Moment</th>
                                <th data-sortable="true">Step</th>
                                <th data-sortable="true">Code</th>
                                <th data-sortable="true" data-type="number">Somme de Charge_NOK</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in evi_moment_code_site %}
                            <tr>
                                <td>{{ row["Site"] }}</td>
                                <td>{{ row["Moment"] }}</td>
                                <td>{{ row["Step"] }}</td>
                                <td>{{ row["Code"] }}</td>
                                <td style="text-align:right;" data-sort-value="{{ row["Somme de Charge_NOK"] }}">{{ row["Somme de Charge_NOK"] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="message">Aucune donn√©e EVI par site.</div>
            {% endif %}
        </div>

        <div class="analysis-card">
            <div class="analysis-title">Downstream ‚Äî Moment √ó Code PC</div>
            {% if ds_moment_code %}
                <div class="table-wrapper">
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                <th data-sortable="true">Moment</th>
                                <th data-sortable="true">Step</th>
                                <th data-sortable="true">Code PC</th>
                                <th data-sortable="true" data-type="number">Somme de Charge_NOK</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in ds_moment_code %}
                            <tr>
                                <td>{{ row["Moment"] }}</td>
                                <td>{{ row["Step"] }}</td>
                                <td>{{ row["Code PC"] }}</td>
                                <td style="text-align:right;" data-sort-value="{{ row["Somme de Charge_NOK"] }}">{{ row["Somme de Charge_NOK"] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="message">Aucun Downstream Code PC non nul pour ce p√©rim√®tre.</div>
            {% endif %}

            <div class="analysis-title" style="margin-top: 1rem;">Downstream ‚Äî Moment √ó Code PC √ó Site</div>
            {% if ds_moment_code_site %}
                <div class="table-wrapper">
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                <th data-sortable="true">Site</th>
                                <th data-sortable="true">Moment</th>
                                <th data-sortable="true">Step</th>
                                <th data-sortable="true">Code PC</th>
                                <th data-sortable="true" data-type="number">Somme de Charge_NOK</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in ds_moment_code_site %}
                            <tr>
                                <td>{{ row["Site"] }}</td>
                                <td>{{ row["Moment"] }}</td>
                                <td>{{ row["Step"] }}</td>
                                <td>{{ row["Code PC"] }}</td>
                                <td style="text-align:right;" data-sort-value="{{ row["Somme de Charge_NOK"] }}">{{ row["Somme de Charge_NOK"] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="message">Aucune donn√©e Downstream par site.</div>
            {% endif %}
        </div>
    </div>

    <div class="analysis-card" style="margin-top: 1rem;">
        <div class="analysis-title">R√©sum√© par site et phase</div>
        {% if site_summary %}
            <div class="table-wrapper">
                <table class="analysis-table">
                    <thead>
                        <tr>
                            <th data-sortable="true">Site</th>
                            <th data-sortable="true" data-type="number">Total</th>
                            <th data-sortable="true" data-type="number">OK</th>
                            <th data-sortable="true" data-type="number">NOK</th>
                            <th data-sortable="true" data-type="number">% R√©ussite</th>
                            <th data-sortable="true" data-type="number">% Erreurs</th>
                            <th data-sortable="true" data-type="number">Nb Avant charge</th>
                            <th data-sortable="true" data-type="number">Nb Charge</th>
                            <th data-sortable="true" data-type="number">Nb Fin de charge</th>
                            <th data-sortable="true" data-type="number">Nb Unknown</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in site_summary %}
                        <tr>
                            <td>{{ row["Site"] }}</td>
                            <td style="text-align:right;" data-sort-value="{{ row["Total_Charges"] }}">{{ row["Total_Charges"] }}</td>
                            <td style="text-align:right;" data-sort-value="{{ row["Charges_OK"] }}">{{ row["Charges_OK"] }}</td>
                            <td style="text-align:right;" data-sort-value="{{ row["Charges_NOK"] }}">{{ row["Charges_NOK"] }}</td>
                            <td style="text-align:right;" data-sort-value="{{ '%.2f'|format(row['% R√©ussite']) }}">{{ '%.2f'|format(row['% R√©ussite']) }}</td>
                            <td style="text-align:right;" data-sort-value="{{ '%.2f'|format(row['% Erreurs']) }}">{{ '%.2f'|format(row['% Erreurs']) }}</td>
                            <td style="text-align:right;" data-sort-value="{{ row["Avant charge"] }}">{{ row["Avant charge"] }}</td>
                            <td style="text-align:right;" data-sort-value="{{ row["Charge"] }}">{{ row["Charge"] }}</td>
                            <td style="text-align:right;" data-sort-value="{{ row["Fin de charge"] }}">{{ row["Fin de charge"] }}</td>
                            <td style="text-align:right;" data-sort-value="{{ row["Unknown"] }}">{{ row["Unknown"] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="message">Aucun r√©sum√© par site disponible.</div>
        {% endif %}
    </div>
{% endif %}

<script>
    (() => {
        const tables = document.querySelectorAll('.analysis-table');
        const parseValue = (text, type) => {
            const cleaned = (text || '').toString().replace('%', '').replace(/\s+/g, '');
            if (type === 'number' && cleaned !== '' && !isNaN(cleaned)) {
                return parseFloat(cleaned);
            }
            return cleaned.toLowerCase();
        };

        tables.forEach((table) => {
            const headers = table.querySelectorAll('th[data-sortable]');
            const tbody = table.querySelector('tbody');
            let currentSort = { index: null, dir: 'asc' };

            const applySort = (index, type) => {
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const dirMultiplier = currentSort.dir === 'asc' ? 1 : -1;

                rows.sort((a, b) => {
                    const aVal = parseValue(a.children[index].dataset.sortValue ?? a.children[index].textContent.trim(), type);
                    const bVal = parseValue(b.children[index].dataset.sortValue ?? b.children[index].textContent.trim(), type);

                    if (aVal < bVal) return -1 * dirMultiplier;
                    if (aVal > bVal) return 1 * dirMultiplier;
                    return 0;
                });

                rows.forEach((row) => tbody.appendChild(row));
            };

            const updateIndicators = (clickedIndex) => {
                headers.forEach((th, idx) => {
                    th.classList.remove('sorted-asc', 'sorted-desc');
                    if (idx === clickedIndex) {
                        th.classList.add(currentSort.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
                    }
                });
            };

            headers.forEach((th, index) => {
                th.addEventListener('click', () => {
                    const type = th.dataset.type || 'text';
                    if (currentSort.index === index) {
                        currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort = { index, dir: 'asc' };
                    }
                    applySort(index, type);
                    updateIndicators(index);
                });
            });
        });
    })();
</script>
